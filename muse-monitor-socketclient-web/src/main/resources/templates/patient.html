<!DOCTYPE HTML>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" xmlns:th="http://www.thymeleaf.org">
<!--<![endif]-->
<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<title>Patient Information - <!-- TODO: Put patient name --></title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="author" content="Basheer Becerra" />

<!-- Google Fonts -->
<link
	href='https://fonts.googleapis.com/css?family=Open+Sans:400,300,700|Monsterrat:400,700|Merriweather:400,300italic,700'
	rel='stylesheet' type='text/css'></link>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
	integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
	crossorigin="anonymous" />

<link href="../static/css/navbar-fixed-side.css"
	th:href="@{/css/navbar-fixed-side.css}" rel="stylesheet"></link>
<link href="../static/css/custom.css" th:href="@{/css/custom.css}"
	rel="stylesheet"></link>
<link href="../static/css/line-graph.css"
	th:href="@{/css/line-graph.css}" rel="stylesheet"></link>
<!-- FOR IE9 below -->
<!--[if lt IE 9]>
	<script src="js/respond.min.js"></script>
	<![endif]-->
</head>


<style> /* set the CSS */
body {
	font: 12px Arial;
}

path {
	stroke: steelblue;
	stroke-width: 2;
	fill: none;
}

.axis path, .axis line {
	fill: none;
	stroke: grey;
	stroke-width: 1;
	shape-rendering: crispEdges;
}
</style>
<body>

	<script src="https://code.jquery.com/jquery-3.2.1.min.js"
		integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		crossorigin="anonymous"></script>

	<!-- Latest compiled and minified JavaScript -->
	<script
		src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
		integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
		crossorigin="anonymous"></script>



	<div id="graph1" class="aGraph"
		style="position: relative; width: 100%; height: 400px"></div>

	<!-- load the d3.js library -->
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script type="text/javascript" src="../static/scripts/line-graph.js"
		th:src="@{/scripts/line-graph.js}"></script>
	<script type="text/javascript" src="../static/data/sample_data.js"
		th:src="@{/data/sample_data.js}"></script>
	<script>
		data["displayNames"] = [ "2xx", "3xx", "4xx", "5xx" ];
		data["colors"] = [ "green", "orange", "red", "darkred" ];
		data["scale"] = "pow";

		// create graph now that we've added presentation config
		var l1 = new LineGraph({
			containerId : 'graph1',
			data : data
		});

		setInterval(function() {
			/*
			 * The following will simulate live updating of the data (see dataA, dataB, dataC etc in data.js which are real examples)
			 * This is being simulated so this example functions standalone without a backend server which generates data such as data.js contains.
			 */
			// for each data series ...
			var newData = [];
			data.values.forEach(function(dataSeries, index) {
				// take the first value and move it to the end
				// and capture the value we're moving so we can send it to the graph as an update
				var v = dataSeries.shift();
				dataSeries.push(v);
				// put this value in newData as an array with 1 value
				newData[index] = [ v ];
			})

			// we will reuse dataA each time
			dataA.values = newData;
			// increment time 1 step
			dataA.start = dataA.start + dataA.step;
			dataA.end = dataA.end + dataA.step;

			l1.slideData(dataA);
		}, 2000);
	</script>

	<script type="text/javascript"
		src="../static/node_modules/webstomp-client/dist/webstomp.min.js"
		th:src="@{/node_modules/webstomp-client/dist/webstomp.min.js}"></script>
	<script type="text/javascript">
		// TODO: Heartbeat implementation
		var url = "wss://muse-monitor-socketserver.herokuapp.com/muse-ws";
		var clients = {
			a : webstomp.client(url)
		}

		var jsonEncoder = {
			encode : function(msg) {
				return JSON.stringify(msg);
			},
			decode : function(msg) {
				return JSON.parse(msg);
			}
		};
		var encoder = {
			encode : jsonEncoder.encode,
			decode : jsonEncoder.decode
		}
		clients.a.heartbeat.outgoing = 20000; // client will send heartbeats every 20000ms
		clients.a.heartbeat.incoming = 0;
		clients.a.connect({}, function(evt) {
		});

		var delayMillis = 2000; //1 second
		var subscriptions = {};
		setTimeout(function() {
			subscriptions = {
				indicator : clients.a.subscribe("/topic/muse-verbose",
						function(message) {
							if (message.body) {
								body = jsonEncoder.decode(message.body);
								// TODO: Temporarily choose the accelX for testing
								data_point = body.accelerometerData[0].accelX;
								console.log(body);

								// Add the valueline path.
								svg.append("path").attr("class", "line").attr(
										"d", valueline(data));

								// Add the X Axis
								svg.append("g").attr("class", "x axis").attr(
										"transform",
										"translate(0," + height + ")").call(
										xAxis);

								// Add the Y Axis
								svg.append("g").attr("class", "y axis").call(
										yAxis);

							}
						})
			};
		}, delayMillis);
	</script>
</body>
</html>